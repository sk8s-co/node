#!/bin/bash
set -Eeuo pipefail
_ARGS="$@"

if [ "${DEBUG:-}" = "true" ]; then
    set -x
fi

source _assert
source _identify
source _initialize

# Build command list based on enabled services
_NAMES="kubelet,dockerd"
_CMDS=("kubelet {*}" "dockerd")

exec /srv/concurrently -P \
--names "$_NAMES" \
--restart-tries -1 \
--restart-after exponential \
--kill-signal SIGINT \
--teardown stop \
"${_CMDS[@]}" \
$_ARGS
