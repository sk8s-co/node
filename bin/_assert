#!/bin/bash
set -euo pipefail

# Redirect all output to stderr
exec >&2

_FAILURES=()

# Check for required volume mount
if [ ! -d "/var/run/kube" ]; then
    _FAILURES+=("-v /var/run/kube:/var/run/kube")
fi

# Check for privileged mode by testing access to /dev/kmsg
# This device is only accessible in privileged containers
if [ ! -r /dev/kmsg ]; then
    _FAILURES+=("--privileged")
fi

# Check for network host mode
if [ "$(readlink /proc/1/ns/net 2>/dev/null)" != "$(readlink /proc/self/ns/net 2>/dev/null)" ]; then
    _FAILURES+=("--network=host")
fi

# Check for PID host mode
# With --pid=host, /proc/1 is the host's init process, not our container entrypoint
_PID1_COMM=$(cat /proc/1/comm 2>/dev/null || echo "")
if [ "$_PID1_COMM" = "_start" ]; then
    _FAILURES+=("--pid=host")
fi

# Check for IPC host mode
# Compare our IPC namespace with PID 1's (the host init)
if [ "$(readlink /proc/1/ns/ipc 2>/dev/null)" != "$(readlink /proc/self/ns/ipc 2>/dev/null)" ]; then
    _FAILURES+=("--ipc=host")
fi

# Check for UTS host mode
# Compare our UTS namespace with PID 1's (the host init)
if [ "$(readlink /proc/1/ns/uts 2>/dev/null)" != "$(readlink /proc/self/ns/uts 2>/dev/null)" ]; then
    _FAILURES+=("--uts=host")
fi

# Report all failures at once
if [ ${#_FAILURES[@]} -ne 0 ]; then
    echo "Error: Container is not configured correctly."
    echo ""
    echo "Missing required settings:"
    echo "  ${_FAILURES[*]}"
    echo ""
    exit 1
fi