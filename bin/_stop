#!/bin/bash
set -euo pipefail

echo "Starting graceful shutdown of Kubernetes containers..."

# Find all containers with the io.kubernetes.docker.type label
KUBE_CONTAINERS=$(docker ps -q --filter "label=io.kubernetes.docker.type" || true)

if [ -z "$KUBE_CONTAINERS" ]; then
    echo "No Kubernetes containers found to stop."
else
    echo "Found Kubernetes containers, stopping gracefully..."

    # Gracefully stop containers (sends SIGTERM, waits 10s, then SIGKILL)
    for container_id in $KUBE_CONTAINERS; do
        echo "Stopping container: $container_id"
        docker stop -s SIGTERM -t 10 "$container_id" || echo "Warning: Failed to stop $container_id"
    done

    echo "Removing stopped containers..."
    for container_id in $KUBE_CONTAINERS; do
        echo "Removing container: $container_id"
        docker rm -f "$container_id" || echo "Warning: Failed to remove $container_id"
    done

    echo "Cleanup complete."
fi

echo "Node Shutdown Complete."
exit 0