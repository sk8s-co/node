#!/bin/bash
set -Eeuo pipefail
exec >&2

# Determine the machine ID
# Priority: MACHINE_ID env var > /etc/machine-id file > "standalone" default
export _MACHINE_ID="${MACHINE_ID:-$(cat /etc/machine-id 2>/dev/null || echo "standalone")}"
# Ensure /etc/machine-id exists
if [ ! -f /etc/machine-id ]; then
    echo "$_MACHINE_ID" > /etc/machine-id
fi
    
# Determine cluster DNS and domain from resolv.conf
# Extract first nameserver as cluster DNS
# - Strip comments and whitespace
# - Validate IPv4 format (basic validation, doesn't check valid ranges)
# - Support IPv6 addresses as well
_CLUSTER_DNS=$(grep -m1 '^[[:space:]]*nameserver[[:space:]]' /etc/resolv.conf | \
    sed 's/#.*//' | \
    awk '{print $2}' | \
    grep -E '^([0-9]{1,3}\.){3}[0-9]{1,3}$|^([0-9a-fA-F:]+:+)+[0-9a-fA-F]+$' || true)

if [ -z "$_CLUSTER_DNS" ]; then
    echo "Error: No valid nameserver found in /etc/resolv.conf" >&2
    echo "Cannot configure cluster DNS without a nameserver." >&2
    exit 1
fi

_CLUSTER_DOMAIN="docker.internal"

export CLUSTER_DOMAIN="$_CLUSTER_DOMAIN"
export CLUSTER_DNS="$_CLUSTER_DNS"
export MACHINE_ID="$_MACHINE_ID"
